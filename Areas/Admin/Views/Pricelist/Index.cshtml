@{
    ViewData["Title"] = "Quản lý bảng giá";
    
}
<div class="container-fluid">
    <div class="card">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold">Quản lý bảng giá</h5>
            <button class="btn btn-primary rounded-pill px-4" onclick="openPricelistModal()">
                <i class="fas fa-plus me-2"></i>Thêm bảng giá
            </button>
        </div>

        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm..." onchange="searchPricelist()">
                        <button class="btn btn-outline-secondary" onclick="searchPricelist()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
              
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4" style="width: 5%">Mã</th>
                            <th style="width: 20%">Tiêu đề</th>
                            <th style="width: 15%">Ngày đăng</th>
                            <th style="width: 10%">Trạng thái </th>
                            <th style="width: 25%" class="text-center">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="pricelistTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer bg-white py-3">
            <nav>
                <ul class="pagination justify-content-center mb-0" id="pagination">
                </ul>
            </nav>
        </div>
    </div>
</div>

<div class="modal fade" id="pricelistModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-3">
                <h4 class="modal-title fw-bold" id="modalTitle">
                    <i class="fas fa-newspaper me-2"></i>
                    Thêm bảng giá
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
                <div class="modal-body bg-light">
                    <div class="container-fluid py-3">
                        <form id="pricelistForm" class="bg-white rounded-3 shadow-sm p-4">

                            <input type="hidden" id="Id_pricelist" name="Id_pricelist">
                            
                            <div class="row g-4 mb-4">
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label class="form-label fw-bold text-primary fs-5 mb-3">
                                            <i class="fas fa-heading me-2"></i>Tiêu đề
                                        </label>
                                       <input type="text" class="form-control form-control-lg shadow-sm" 
                                           id="Title" name="Title" placeholder="Nhập tiêu đề ...">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-4">
                                <label class="form-label fw-bold text-primary fs-5 mb-3">
                                    <i class="fas fa-link me-2"></i>Ngày đăng
                                </label>
                            <input type="date" 
                            class="form-control form-control-lg shadow-sm" 
                            id="Created_At" 
                            name="Created_At" 
                            value="@DateTime.Now.ToString("yyyy-MM-dd")" />    
                            </div>
                            <div class="form-group">
                                <label class="form-label fw-bold text-primary fs-5 mb-3">
                                    <i class="fas fa-edit me-2"></i>Mô tả
                                </label>
                                <textarea id="Description" name="Description" class="summernote"></textarea>
                           
                            </div>
                            <div class="form-group mt-4">
                                <select class="form-select form-select-lg shadow-sm" name="IsActive" id="IsActive">
                                    <option value="true">Hiện</option>
                                    <option value="false">Ẩn</option>
                                </select>
                            </div>
                                

                        
                        </form>
                    </div>
                </div>
                <div class="modal-footer border-top shadow-sm">
                    <button type="button" class="btn btn-light btn-lg rounded-pill px-5" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Đóng
                    </button>
                    <button type="button" class="btn btn-primary btn-lg rounded-pill px-5" id="btnSavePricelist">
                        <i class="fas fa-save me-2"></i>Lưu
                    </button>
                </div>
            </div>
        </div>
    </div>
@{
    var summenote = new websitebenhvien.Models.EnitityVM.Summenote(".summernote");
}
<partial name="_Summernote" model="summenote" />
@section Scripts {
    <script>

            var page=1
            var pagesize=20
            var searchtt = ''; // Khởi tạo rỗng để không bị "undefined"
            var filename;

        $(document).ready(function() {
            $('#pricelistModal').on('hidden.bs.modal', function () {
                $('#pricelistForm')[0].reset();
                $('#Description').summernote('code', '');
                $('#Id_pricelist').val('');
                $('#modalTitle').text('Thêm bảng giá');
                const today = new Date();
                const formattedDate = today.toISOString().split('T')[0]; 
                $('#Created_At').val(formattedDate);
                $('#IsActive').val('true'); // Reset về giá trị mặc định
            });

            $('#btnSavePricelist').click(function() {
                SavePricelist();
            });

            loadPricelist(searchtt,page,pagesize);
        });

      
        

        function loadPricelist(searchtt,page,pagesize) {
            $.ajax({
                url: '/api-bang-gia-danh-sach',
                type: 'POST',
                data: { page: page, pagesize: pagesize, search: searchtt },
                success: function(response) {
                    if (response.status) {
                        renderPricelist(response.data);
                        renderPagination(response.totalpage, response.pageindex);
                    }
                }
            });
        }

        function renderPricelist(data) {
            const tbody = $('#pricelistTableBody');
            tbody.empty();
            
            data.forEach((item, index) => {
                tbody.append(`
                    <tr>
                        <td class="ps-4">TT${item.id_pricelist}</td>
                        <td>${item.title}</td>
                        <td>${item.created_At.split('T')[0]}</td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" 
                                    id="status_${item.id_pricelist}" 
                                    ${item.isActive ? 'checked' : ''}
                                    onchange="updatePricelistStatus('${item.id_pricelist}')">
                                <label class="form-check-label" for="status_${item.id_pricelist}">
                                    ${item.isActive ? 'Hiện' : 'Ẩn'}
                                </label>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="d-flex justify-content-center">
                                <button class="btn btn-sm btn-primary me-2" onclick="editPricelist('${item.id_pricelist}')" 
                                        data-bs-toggle="tooltip" title="Sửa">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePricelist('${item.id_pricelist}')"
                                        data-bs-toggle="tooltip" title="Xóa">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `);
            });
        }
       function renderPagination( totalPages, currentPage) {
            let html = '';
            
            // Đảm bảo searchtt là chuỗi, kể cả khi nó null hoặc undefined
            const currentSearch = searchtt || ''; 

            if (totalPages <= 5) {
                // Show all pages if total pages <= 5
                for (let i = 1; i <= totalPages; i++) {
                    html += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="loadPricelist('${currentSearch}', ${i}, ${pagesize})">${i}</a>
                        </li>
                    `;
                }
            } else {
                // Add Previous button
                html += `
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="loadPricelist('${currentSearch}', ${currentPage - 1}, ${pagesize})">&laquo;</a>
                    </li>
                `;

                // Show first page
                html += `
                    <li class="page-item ${currentPage === 1 ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadPricelist('${currentSearch}', 1, ${pagesize})">1</a>
                    </li>
                `;

                // Add ellipsis if needed
                if (currentPage > 3) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }

                // Show pages around current page
                for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) {
                    html += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="loadPricelist('${currentSearch}', ${i}, ${pagesize})">${i}</a>
                        </li>
                    `;
                }

                // Add ellipsis if needed
                if (currentPage < totalPages - 2) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }

                // Show last page
                html += `
                    <li class="page-item ${currentPage === totalPages ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadPricelist('${currentSearch}', ${totalPages}, ${pagesize})">${totalPages}</a>
                    </li>
                `;

                // Add Next button
                html += `
                    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="loadPricelist('${currentSearch}', ${currentPage + 1}, ${pagesize})">&raquo;</a>
                    </li>
                `;
            }

            $('#pagination').html(html);
        }


   
        function openPricelistModal() {
            $('#modalTitle').text('Thêm bảng giá');
            $('#pricelistForm')[0].reset();
            $('#Id_pricelist').val('');
            $('#Description').summernote('code', ''); // Reset summernote
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0]; 
            $('#Created_At').val(formattedDate); // Set ngày mặc định
            $('#IsActive').val('true'); // Set trạng thái mặc định
            $('#pricelistModal').modal('show');
        }

        function searchPricelist() {
            searchtt=$('#searchInput').val();
            page = 1; // Reset về trang 1 khi tìm kiếm
            loadPricelist(searchtt,page,pagesize);
        }

   
        // Các hàm CRUD
        function SavePricelist() {
            // Get form data
            const form = $('#pricelistForm')[0];
            const formData = new FormData(form);
            var id=$('#Id_pricelist').val();


            // Add description from summernote
            formData.set('Description', $('#Description').summernote('code'));

            // Send AJAX request
            $.ajax({
                url: '/api-bang-gia-them-cap-nhat',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: function() { 
                    Swal.fire({
                        title: 'Chờ một xíu....',
                        html: `
                            <div class="text-center">
                                <img src="https://i.pinimg.com/originals/fe/a5/33/fea5336ece9573d235870d51b8d28e7a.gif" width="100" height="100" alt="Loading..." />
                                <div class="progress mt-3" style="height: 20px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                         role="progressbar" 
                                         style="width: 0%"
                                         aria-valuenow="0" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                    </div>
                                </div>
                            </div>
                        `,
                        showConfirmButton: false,
                        allowOutsideClick: false,
                        background: '#ffffff',
                        didOpen: () => {
                            let progress = 0;
                            const bar = document.querySelector('.progress-bar');
                            const interval = setInterval(() => {
                                progress += 2;
                                bar.style.width = progress + '%';
                                bar.setAttribute('aria-valuenow', progress);
                                if (progress >= 100) {
                                    clearInterval(interval);
                                }
                            }, 50);
                        }
                    });
                },
                success: function(response) {
                    if (response.status) {
                        Swal.close();
                        $('#pricelistModal').modal('hide');
                        loadPricelist(searchtt,page,pagesize); // Tải lại dữ liệu
                        $('#Description').summernote('code', '');
                        $('#pricelistForm')[0].reset();
                        Swal.fire({
                            title: id ? 'Cập nhật' : 'Thêm',
                            text: id ? 'Cập nhật thành công' : 'Thêm thành công',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });

                    } else {
                        Swal.fire({
                            title: 'Lỗi!',
                            text: response.message,
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                },
                error: function(xhr, status, error) {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Có lỗi xảy ra khi kết nối với server',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });
        }

        function deletePricelist(id) {

            Swal.fire({
                title: 'Xác nhận xóa?',
                text: "Bạn có chắc chắn muốn xóa bảng giá này không?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6', 
                cancelButtonColor: '#d33',
                confirmButtonText: 'Đồng ý',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/api-bang-gia-xoa',
                        type: 'POST',
                        data: { id: id },
                        
                        success: function(response) {
                            if (response.status) {
                                Swal.fire({
                                    title: 'Thành công!',
                                    text: response.message,
                                    icon: 'success',
                                    confirmButtonText: 'OK'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        loadPricelist(searchtt,page,pagesize);
                                    }
                                });
                            } else {
                                Swal.fire({
                                    title: 'Lỗi!',
                                    text: response.message,
                                    icon: 'error',
                                    confirmButtonText: 'OK'
                                });
                            }
                        },
                        error: function(xhr, status, error) {
                            Swal.fire({
                                title: 'Lỗi!',
                                text: 'Có lỗi xảy ra khi kết nối với server',
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                    });
                }
            });
        }
        function editPricelist(id) {
            $('#modalTitle').text('Sửa bảng giá ');
            $('#pricelistForm')[0].reset();
            
            $.ajax({
                url: '/api-bang-gia-lay',
                type: 'POST',
                data: { id: id },
                beforeSend: function() {
                    Swal.fire({
                        title: 'Chờ một xíu....',
                        html: `
                            <div class="text-center">
                                <img src="https://i.pinimg.com/originals/fe/a5/33/fea5336ece9573d235870d51b8d28e7a.gif" width="100" height="100" alt="Loading..." />
                                <div class="progress mt-3" style="height: 20px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                         role="progressbar" 
                                         style="width: 0%"
                                         aria-valuenow="0" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                    </div>
                                </div>
                            </div>
                        `,
                        showConfirmButton: false,
                        allowOutsideClick: false,
                        background: '#ffffff',
                        didOpen: () => {
                            let progress = 0;
                            const bar = document.querySelector('.progress-bar');
                            const interval = setInterval(() => {
                                progress += 2;
                                bar.style.width = progress + '%';
                                bar.setAttribute('aria-valuenow', progress);
                                if (progress >= 100) {
                                    clearInterval(interval);
                                }
                            }, 50);
                        }
                    });
                },
                success: function(response) {
                    if (response.status) {
                        Swal.close();
                        const data = response.data;
                   
                        $('#Id_pricelist').val(data.id_pricelist);
                        $('#Title').val(data.title);
                        $('#Description').summernote('code', data.description);
                        $('#Created_At').val(data.created_At.split('T')[0]);
                        $('#IsActive').val(data.isActive.toString()); // Chuyển bool sang string cho select
                        
                        $('#pricelistModal').modal('show');
                    } else {
                        Swal.fire({
                            title: 'Lỗi!',
                            text: response.message,
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                },
                error: function(xhr, status, error) {
                    Swal.close();
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Có lỗi xảy ra khi kết nối với server',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });
        }
        // update status
        function updatePricelistStatus(id) {
            $.ajax({
                url: '/api-bang-gia-chuyen-trang-thai',
                type: 'POST',
                data: { id: id },
                success: function(response) {
                    if (response.status) {
                        loadPricelist(searchtt,page,pagesize);
                    } else {
                         Swal.fire({
                            title: 'Lỗi!',
                            text: response.message,
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                },
                 error: function(xhr, status, error) {
                    Swal.fire({
                        title: 'Lỗi!',
                        text: 'Có lỗi xảy ra khi kết nối với server',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });
        }
    </script>
}