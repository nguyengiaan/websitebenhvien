@{
    ViewData["Title"] = "Phân quyền chức năng";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Phân quyền chức năng</h3>
                </div>
                <div class="card-body">
                    <table id="permissionTable" class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Tên người dùng</th>
                                <th>Thêm</th>
                                <th>Xem</th>
                                <th>Sửa</th>
                                <th>Xóa</th>
                   
                            </tr>
                        </thead>
                        <tbody id="permissionTableBody">
                        </tbody>
                    </table>
                    <div class="mt-3">
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center" id="pagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cập nhật quyền -->


@section Scripts {
    <script>
        $(document).ready(function() {
            loadPermissions();
        });

        function loadPermissions() {
            $.ajax({
                url: '/api/ds-phan-quyen-chuc-nang',
                type: 'GET',
                success: function(response) {
                    if (response.status) {
                        console.log(response.data)
                        displayPermissions(response.data);
                    }
                },
                error: function() {
                    Swal.fire('Lỗi!', 'Không thể tải danh sách phân quyền', 'error');
                }
            });
        }

        function displayPermissions(permissions) {
            const tbody = $('#permissionTableBody');
            tbody.empty();
            
            permissions.forEach((permission, index) => {
                tbody.append(`
                    <tr>
                        <td>${index + 1}</td>
                        <td>${permission.fullname}</td>
                        <td>
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input permission-checkbox" 
                                       id="add-${permission.id_user}"
                                       data-userid="${permission.id_user}" 
                                       data-permission="1"
                                       data-idpermissionuser="${permission.ds.map(p => p.id_Permission).join(',')}"
                                       ${permission.ds.some(p => p.id_Permission === 1) ? 'checked' : ''}>
                                <label class="custom-control-label" for="add-${permission.id_user}"></label>
                            </div>
                        </td>
                        <td>
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input permission-checkbox"
                                       id="view-${permission.id_user}"
                                       data-userid="${permission.id_user}"
                                       data-permission="2" 
                                       data-idpermissionuser="${permission.ds.map(p => p.id_Permission).join(',')}"
                                       ${permission.ds.some(p => p.id_Permission === 3) ? 'checked' : ''}>
                                <label class="custom-control-label" for="view-${permission.id_user}"></label>
                            </div>
                        </td>
                        <td>
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input permission-checkbox"
                                       id="edit-${permission.id_user}"
                                       data-userid="${permission.id_user}"
                                       data-permission="3"
                                       data-idpermissionuser="${permission.ds.map(p => p.id_Permission).join(',')}"
                                       ${permission.ds.some(p => p.id_Permission === 2) ? 'checked' : ''}>
                                <label class="custom-control-label" for="edit-${permission.id_user}"></label>
                            </div>
                        </td>
                        <td>
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input permission-checkbox"
                                       id="delete-${permission.id_user}"
                                       data-userid="${permission.id_user}"
                                       data-permission="4"
                                       data-idpermissionuser="${permission.ds.map(p => p.id_Permission).join(',')}"
                                       ${permission.ds.some(p => p.id_Permission === 4) ? 'checked' : ''}>
                                <label class="custom-control-label" for="delete-${permission.id_user}"></label>
                            </div>
                        </td>
                       
                    </tr>
                `);
            });
        }

        function editPermissions(userId, userName) {
            $('#userId').val(userId);
            $('#userName').text(userName);
            
            // Lấy thông tin quyền hiện tại
            $.ajax({
                url: '/api/chi-tiet-phan-quyen',
                type: 'GET',
                data: { userId: userId },
                success: function(response) {
                    if (response.status) {
                        const permissions = response.data;
                        $('#canAdd').prop('checked', permissions.canAdd);
                        $('#canView').prop('checked', permissions.canView);
                        $('#canEdit').prop('checked', permissions.canEdit);
                        $('#canDelete').prop('checked', permissions.canDelete);
                        $('#permissionModal').modal('show');
                    }
                }
            });
        }

        function savePermissions() {
            var data={
                userId: $('#userId').val(),
                canAdd: $('#canAdd').prop('checked'),
                canView: $('#canView').prop('checked'),
                canEdit: $('#canEdit').prop('checked'),
                canDelete: $('#canDelete').prop('checked')
            }
            $.ajax({
                url: '/api/cap-nhat-phan-quyen',
                type: 'POST',
                data: data,
                success: function(response) {
                    if (response.status) {
                        $('#permissionModal').modal('hide');
                        Swal.fire('Thành công!', 'Cập nhật quyền thành công', 'success');
                        loadPermissions();
                    } else {
                        Swal.fire('Lỗi!', response.message || 'Có lỗi xảy ra', 'error');
                    }
                },
                error: function() {
                    Swal.fire('Lỗi!', 'Không thể cập nhật quyền', 'error');
                }
            });
        }
    </script>
}
