@model websitebenhvien.Models.EnitityVM.PostactivityVM
@{
    ViewData["Title"] = "Thêm mới hoạt động";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">Thêm mới hoạt động</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home", new { Area = "Admin" })">Trang chủ</a></li>
                        <li class="breadcrumb-item"><a href="@Url.Action("Index")">Hoạt động</a></li>
                        <li class="breadcrumb-item active">Thêm mới</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Thông tin hoạt động</h3>
                </div>

                <form asp-action="Create" method="post" enctype="multipart/form-data" class="form-horizontal">
                    <div class="card-body">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        <div class="row">
                            <div class="col-md-8">
                                <!-- Tiêu đề -->
                                <div class="form-group">
                                    <label asp-for="Title" class="control-label">Tiêu đề <span class="text-danger">*</span></label>
                                    <input asp-for="Title" class="form-control" placeholder="Nhập tiêu đề hoạt động..." />
                                    <span asp-validation-for="Title" class="text-danger"></span>
                                </div>

                                <!-- Mô tả ngắn -->
                                <div class="form-group">
                                    <label asp-for="Descriptionshort" class="control-label">Mô tả ngắn</label>
                                    <textarea asp-for="Descriptionshort" class="form-control" rows="3" 
                                              placeholder="Nhập mô tả ngắn..."></textarea>
                                    <span asp-validation-for="Descriptionshort" class="text-danger"></span>


                                </div>

                                <!-- Nội dung chính với Summernote -->
                                <div class="form-group">
                                    <label asp-for="Description" class="control-label">Nội dung chính <span class="text-danger">*</span></label>
                                    <textarea asp-for="Description" class="form-control summernote" rows="10"></textarea>
                                    <span asp-validation-for="Description" class="text-danger"></span>
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-info btn-sm" id="btnGenerateKeywords">
                                            <i class="fa fa-magic"></i> Tạo từ khóa tự động
                                        </button>
                                        <button type="button" class="btn btn-success btn-sm" id="btnGenerateSchema">
                                            <i class="fa fa-code"></i> Tạo Schema tự động
                                        </button>
                                    </div>
                                </div>

                      
                            

                                <!-- Alias URL -->
                                <div class="form-group">
                                    <label asp-for="Alias_url" class="control-label">Alias URL</label>
                                    <input asp-for="Alias_url" class="form-control" placeholder="Nhập alias URL..." />
                                    <span asp-validation-for="Alias_url" class="text-danger"></span>
                                </div>

                                <!-- Từ khóa -->
                                <div class="form-group">
                                    <label asp-for="Keyword" class="control-label">Từ khóa SEO</label>
                                    <input asp-for="Keyword" class="form-control" placeholder="Nhập từ khóa SEO..." />
                                    <span asp-validation-for="Keyword" class="text-danger"></span>
                                </div>

                                <!-- Schema Markup -->
                                <div class="form-group">
                                    <label asp-for="SchemaMakup" class="control-label">Schema Markup</label>
                                    <textarea asp-for="SchemaMakup" class="form-control" rows="4" 
                                              placeholder="Nhập schema markup..."></textarea>
                                    <span asp-validation-for="SchemaMakup" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <!-- Hình ảnh thumbnail -->
                                <div class="form-group">
                                    <label asp-for="ThumbnailFile" class="control-label">Hình ảnh đại diện</label>
                                    <div class="custom-file">
                                        <input asp-for="ThumbnailFile" class="custom-file-input" id="thumbnailFile" accept="image/*" />
                                        <label class="custom-file-label" for="thumbnailFile">Chọn hình ảnh...</label>
                                    </div>
                                    <span asp-validation-for="ThumbnailFile" class="text-danger"></span>
                                    <div class="mt-2">
                                        <img id="thumbnailPreview" src="#" alt="Preview" style="max-width: 200px; max-height: 200px; display: none;" class="img-thumbnail" />
                                    </div>
                                </div>

                                <!-- Danh mục -->
                                <div class="form-group">
                                    <label asp-for="Id_Categoryactivity" class="control-label">Danh mục <span class="text-danger">*</span></label>
                                    <select asp-for="Id_Categoryactivity" class="form-control">
                                        <option value="">-- Chọn danh mục --</option>
                                        @foreach (var item in ViewBag.Categories as SelectList)
                                        {
                                            <option value="@item.Value">@item.Text</option>
                                        }
                                    </select>
                                    <span asp-validation-for="Id_Categoryactivity" class="text-danger"></span>
                                </div>

                                <!-- Trạng thái -->
                                <div class="form-group">
                                    <label asp-for="Status" class="control-label">Trạng thái</label>
                                    <div class="form-check">
                                        <input asp-for="Status" class="form-check-input" type="checkbox" checked />
                                        <label class="form-check-label" asp-for="Status">
                                            Kích hoạt
                                        </label>
                                    </div>
                                    <span asp-validation-for="Status" class="text-danger"></span>
                                </div>

                                <!-- Hướng dẫn -->
                                <div class="card card-info">
                                    <div class="card-header">
                                        <h3 class="card-title">Hướng dẫn</h3>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-unstyled">
                                            <li><i class="fa fa-check text-success"></i> Tiêu đề và nội dung là bắt buộc</li>
                                            <li><i class="fa fa-check text-success"></i> Mô tả ngắn hiển thị trong danh sách</li>
                                            <li><i class="fa fa-check text-success"></i> Sử dụng Summernote để định dạng nội dung</li>
                                            <li><i class="fa fa-check text-success"></i> URL phải là duy nhất</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-footer">
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-save"></i> Lưu lại
                                </button>
                                <a href="@Url.Action("Index")" class="btn btn-secondary">
                                    <i class="fa fa-times"></i> Hủy bỏ
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>
</div>
@{
    var summenote = new websitebenhvien.Models.EnitityVM.Summenote(".summernote");
}
<partial name="_Summernote" model="summenote" />
@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    
    <script>
        $(document).ready(function() {
            // Khởi tạo Summernote
    
            // Auto-generate alias URL from title
            $('#Title').on('input', function() {
                var title = $(this).val();
                var alias = convertToSlug(title);
                $('#Alias_url').val("/hoat-dong/" + alias);
            });

            // Thumbnail file preview
            $('#thumbnailFile').on('change', function() {
                var file = this.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        $('#thumbnailPreview').attr('src', e.target.result).show();
                    };
                    reader.readAsDataURL(file);
                    
                    // Update file label
                    $('.custom-file-label').text(file.name);
                } else {
                    $('#thumbnailPreview').hide();
                    $('.custom-file-label').text('Chọn hình ảnh...');
                }
            });

            // Generate Keywords AJAX
            $('#btnGenerateKeywords').on('click', function() {
                var title = $('#Title').val();
                var description = $('.summernote').summernote('code');
                
                // Remove HTML tags for keywords generation
                var textDescription = $('<div>').html(description).text();
                
                if (!textDescription.trim()) {
                    Swal.fire('Lỗi', 'Vui lòng nhập nội dung trước khi tạo từ khóa', 'error');
                    return;
                }

                var baseUrl = '@Url.Action("GenerateKeywords", "Activitypost", new { Area = "Admin" })';
                
                $.ajax({
                    url: baseUrl,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        title: title,
                        description: textDescription
                    }),
                    beforeSend: function() {
                        $('#btnGenerateKeywords').prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Đang tạo...');
                    },
                    success: function(response) {
                        if (response.status) {
                            $('#Keyword').val(response.data.keywords);
                            Swal.fire('Thành công', response.message, 'success');
                        } else {
                            Swal.fire('Lỗi', response.message, 'error');
                        }
                    },
                    error: function() {
                        Swal.fire('Lỗi', 'Có lỗi xảy ra khi tạo từ khóa', 'error');
                    },
                    complete: function() {
                        $('#btnGenerateKeywords').prop('disabled', false).html('<i class="fa fa-magic"></i> Tạo từ khóa tự động');
                    }
                });
            });

            // Generate Schema Markup AJAX
            $('#btnGenerateSchema').on('click', function() {
                var title = $('#Title').val();
                var description = $('.summernote').summernote('code');
                var url = $('#Url').val();
                var shortDescription = $('#Descriptionshort').val();
                
                // Remove HTML tags for schema generation
                var textDescription = $('<div>').html(description).text();
                
                // Validate all required fields
                if (!title.trim()) {
                    Swal.fire('Lỗi', 'Vui lòng nhập tiêu đề', 'error');
                    $('#Title').focus();
                    return;
                }
                
                if (!textDescription.trim()) {
                    Swal.fire('Lỗi', 'Vui lòng nhập nội dung chính', 'error');
                    $('.summernote').summernote('focus');
                    return;
                }
                
                if (!shortDescription.trim()) {
                    Swal.fire('Lỗi', 'Vui lòng nhập mô tả ngắn để tạo Schema', 'error');
                    $('#Descriptionshort').focus();
                    return;
                }
                
                if (!url.trim()) {
                    Swal.fire('Lỗi', 'Vui lòng nhập URL để tạo Schema', 'error');
                    $('#Url').focus();
                    return;
                }

                var baseUrl = '@Url.Action("GenerateSchemaMarkup", "Activitypost", new { Area = "Admin" })';
                
                // Get thumbnail URL if a file is selected
                var thumbnailUrl = null;
                var thumbnailFile = $('#thumbnailFile')[0].files[0];
                if (thumbnailFile) {
                    // For new files, we can't get the server URL yet, but we can indicate a file is selected
                    thumbnailUrl = '/uploads/activities/placeholder.jpg'; // Will be replaced with actual URL after upload
                }
                
                $.ajax({
                    url: baseUrl,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        title: title,
                        description: shortDescription, // Use short description for schema
                        url: url,
                        thumbnail: thumbnailUrl
                    }),
                    beforeSend: function() {
                        $('#btnGenerateSchema').prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Đang tạo...');
                    },
                    success: function(response) {
                        if (response.status) {
                            $('#SchemaMakup').val(response.data.schemaMarkup);
                            Swal.fire('Thành công', response.message, 'success');
                        } else {
                            Swal.fire('Lỗi', response.message, 'error');
                        }
                    },
                    error: function() {
                        Swal.fire('Lỗi', 'Có lỗi xảy ra khi tạo Schema Markup', 'error');
                    },
                    complete: function() {
                        $('#btnGenerateSchema').prop('disabled', false).html('<i class="fa fa-code"></i> Tạo Schema tự động');
                    }
                });
            });

            function convertToSlug(text) {
                return text
                    .toLowerCase()
                    .replace(/á|à|ả|ạ|ã|ă|ắ|ằ|ẳ|ẵ|ặ|â|ấ|ầ|ẩ|ẫ|ậ/gi, 'a')
                    .replace(/é|è|ẻ|ẽ|ẹ|ê|ế|ề|ể|ễ|ệ/gi, 'e')
                    .replace(/i|í|ì|ỉ|ĩ|ị/gi, 'i')
                    .replace(/ó|ò|ỏ|õ|ọ|ô|ố|ồ|ổ|ỗ|ộ|ơ|ớ|ờ|ở|ỡ|ợ/gi, 'o')
                    .replace(/ú|ù|ủ|ũ|ụ|ư|ứ|ừ|ử|ữ|ự/gi, 'u')
                    .replace(/ý|ỳ|ỷ|ỹ|ỵ/gi, 'y')
                    .replace(/đ/gi, 'd')
                    .replace(/\s+/g, '-')
                    .replace(/[^\w\-]+/g, '')
                    .replace(/\-\-+/g, '-')
                    .replace(/^-+/, '')
                    .replace(/-+$/, '');
            }
        });
    </script>
}
